--[[
    Code description
    
    This script is used for all client-side player actions after the 'FirstScript'
]]





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- üõé Game services üõé
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Game services for our code

-- > Sorted alphabetically
-- > Services use PascalCase
-- > Services are get using GetService()
----------------------------------------------------------------

local GuiService = game:GetService("GuiService")
local Players = game:GetService("Players")
local ReplicatedFirst = game:GetService("ReplicatedFirst")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")
local TweenService = game:GetService("TweenService")





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- ‚öôÔ∏è Settings ‚öôÔ∏è
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Values that can be tweaked to alter the game

-- > Sorted by category, then alphabetically 
-- > Settings use PascalCase
-- > Private settings have a underscore in front of them
----------------------------------------------------------------

-- ‚ñà üì± Device üì± ‚ñà

-- When to toggle to PC as device used
local DeviceBreakPoint = 768 -- pixels



-- ‚ñà üëÅÔ∏è Interface üëÅÔ∏è ‚ñà

-- Length of the fade transitions
local FadeDuration = 1 -- in seconds

-- How long one scrolling round of the titlescreen background takes
local TitleBackgroundScrollDuration = 60 -- in seconds





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- üíé Instance variables üíé
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Variables like paths and objects

-- > Sorted by order of requirement, category and then alphabetically
-- > Variables use camelCase
-- > Private variables have a underscore in front of them
----------------------------------------------------------------

-- ‚ñà üìÅ Folders üìÅ ‚ñà
local remotes = ReplicatedStorage:WaitForChild("Remotes")



-- ‚ñà üì∑ Camera üì∑ ‚ñà
local currentCamera = workspace.CurrentCamera



-- ‚ñà üì° Connections üì° ‚ñà
local gameLoadedRemote = remotes:WaitForChild("GameLoaded")



-- ‚ñà ‚õ∑ Player ‚õ∑ ‚ñà
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")



-- ‚ñà üéº Sound üéº ‚ñà
local music = SoundService:WaitForChild("Music")





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- üìä Normal variables üìä
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Variables like tables and information

-- > Sorted by order of requirement, category and then alphabetically
-- > Variables use camelCase
-- > Private variables have a underscore in front of them
----------------------------------------------------------------





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- üìÑ Preset values üìÑ
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Used to hold preset values for later on

-- > Sorted on category and then alphabetically
-- > Variables use camelCase
-- > Private variables have a underscore in front of them
----------------------------------------------------------------

-- ‚ñà üì± Device üì± ‚ñà
local device = "Mobile"



-- ‚ñà üëÅÔ∏è Interface üëÅÔ∏è ‚ñà
local screenGui = playerGui:WaitForChild("Mobile")



-- ‚ñà ‚õì Coroutines ‚õì ‚ñà
local asyncList = {}
local asyncStats = {}





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- üßÆ Calculated values üßÆ
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Values that require other values or functions to be determind

-- > Sorted by order of requirement, category and alphabetically
-- > Variables and functions use camelCase
-- > Private variables or functions have a underscore in front of them
----------------------------------------------------------------

-- ‚ñà üì± Device üì± ‚ñà

-- Returns the device used by the player
local function getDeviceType()
    local largeScreen = currentCamera.ViewportSize.X > DeviceBreakPoint

    -- Only consoles use 'ten foot interfaces'
    if GuiService:IsTenFootInterface() then
        if largeScreen then
            return "Console"
        else
            return "SmallConsole"
        end
    end

    if largeScreen then
        return "PC"
    else
        return "Mobile"
    end
end

-- First time initialization
getDeviceType()

-- TODO TESTCODE
device = "Mobile"



-- ‚ñà üëÅÔ∏è Interface üëÅÔ∏è ‚ñà

-- Updates what screenGui is being used and turns off the others
local function setScreenGui()
    local screenGuis = playerGui:GetChildren()
    
    -- List of screengui's allowed to close
    local whitelist = {
        "Mobile",
        "PC",
        "Console",
        "SmallConsole"
    }

    -- Turns off all other screenGui's
    for index, screenGui in pairs(screenGuis) do
        if screenGui:IsA("ScreenGui") and table.find(whitelist, screenGui.Name) then
            screenGui.Enabled = false
        end
    end

    -- Opens the right screenGui
    local screenGui = playerGui:WaitForChild(device)
    screenGui.Enabled = true
end

-- First time initialization
setScreenGui()





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- üóú Functions üóú
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Runnable blocks of code, not required at startup

-- > Sorted by order of requirement, category and alphabetically
-- > Functions use camelCase
-- > Private variables have a underscore in front of them
----------------------------------------------------------------

-- ‚ñà ‚õì Coroutines ‚õì ‚ñà

-- Starts a function async, with optional parameters to be parsed
function startAsync(functionObject, parameters)
    -- Creates a string of the function's id
    local asyncName = tostring(functionObject)

    -- Creates a coroutine function
    local asyncFunction = coroutine.create(functionObject)

    -- Puts the function and its status inside tables
    asyncList[asyncName] = asyncFunction
    asyncStats[asyncName] = "Running"

    -- Start the coroutine
    coroutine.resume(asyncFunction, asyncName, parameters)
end



-- Returns the coroutine status
local function isAsyncRunning(asyncName)
    if asyncList[asyncName] then
        return coroutine.status(asyncList[asyncName])
    end
end



-- Stops a coroutine using the function parsed previously at 'startAsync()'
local function stopAsync(functionObject)
    -- Creates a string of the function's id
    local asyncName = tostring(functionObject)

    -- Gets the function from the list using its roblox function id
    local asyncFunction = asyncList[asyncName]

    if asyncFunction then
        -- Makes the loops stop
        asyncStats[asyncName] = "Stopping"

        -- Waits for function to ended properly
        while asyncStats[asyncName] == "Stopping" and isAsyncRunning(asyncName) do
            task.wait()
        end

        -- Ends the coroutine after the running has finished
        coroutine.close(asyncFunction)
        asyncStats[asyncName] = nil
        asyncList[asyncName] = nil
    end
end



-- ‚ñà üëÅÔ∏è Interface üëÅÔ∏è ‚ñà

-- Darkens the screen for transition effects
local function startFade(transparency, duration)
    -- Create the tween info
    local fadeScreen = screenGui:WaitForChild("FadeScreen")
    local fadeTweenInfo = TweenInfo.new(
        1,
        Enum.EasingStyle.Circular,
        Enum.EasingDirection.In
    )
    
    -- Create the tween
    local fadeTween = TweenService:Create(
        fadeScreen,
        fadeTweenInfo,
        {BackgroundTransparency = transparency})
    
    -- Run the tween
    fadeTween:Play()
end



-- Scrolls the background of the titleframe
local function scrollTitleBackground(asyncName)
    local titleScreen = screenGui:WaitForChild("TitleScreen")
    local scroller = titleScreen:WaitForChild("Scroller")
        
    -- Scrolls the background while the coroutine is still active
    while asyncStats[asyncName] == "Running" do
        -- Reset the scroller
        scroller.Position = UDim2.new(0,0,0,0)
        
        -- Create tween info
        local scrollTweenInfo = TweenInfo.new(
            TitleBackgroundScrollDuration,
            Enum.EasingStyle.Linear,
            Enum.EasingDirection.In
        )
        
        -- Create the scrolling tween
        local tween = TweenService:Create(
            scroller,
            scrollTweenInfo,
            {Position = UDim2.new(-4,0,0,0)}
        )
        
        -- Run the tween
        tween:Play()
        
        -- Wait for the tween to end
        task.wait(TitleBackgroundScrollDuration)
    end

    -- Stops it after the loop completed during a 'stopAsync()'
    asyncStats[asyncName] = "Stopped"
end



-- Flashes a flash textlabel
local function flashText(flashTextLabel, transparency, duration)
    local titleFlashTweenInfo = TweenInfo.new(
        duration,
        Enum.EasingStyle.Sine,
        Enum.EasingDirection.In
    )
    
    -- Create a tween
    local titleFlashTween = TweenService:Create(
        flashTextLabel,
        titleFlashTweenInfo,
        {TextTransparency = transparency}
    )
    
    -- Run the tween
    titleFlashTween:Play()
end



-- ‚ñà üïπ Game üïπ ‚ñà

-- This will continue to load the game where the 'FirstScript' left of
local function loadPlayer()
    -- Get the fadescreen and set its transparency
    local fadeScreen = screenGui:WaitForChild("FadeScreen")
    fadeScreen.BackgroundTransparency = 0
    
    -- Close the loadgui
    local loadGui = playerGui:WaitForChild("LoadGui")
    loadGui.Enabled = false
    
    -- Open the titlescreen
    local titleScreen = screenGui:WaitForChild("TitleScreen")
    titleScreen.Visible = true
    
    -- Start playing the intro music
    local introMusic = music:WaitForChild("Intro")
    introMusic:Play()
    
    -- Start rotating the background
    startAsync(scrollTitleBackground)
    
    -- Fade out the fadescreen
    startFade(1, FadeDuration)
    
    -- Wait for the fade transition to end
    task.wait(FadeDuration)
    
    -- Wait a short delay before flashing in the title
    task.wait(1)
    
    -- Flash in the title
    local title = titleScreen:WaitForChild("Title")
    local titleFlash = titleScreen:WaitForChild("TitleFlash")
    flashText(titleFlash, 0, 0.5)
    
    -- Wait for the tween to end
    task.wait(0.5)
    
    -- Show the real title
    title.Visible = true
    
    -- End the flash
    flashText(titleFlash, 1, 1)
    
    -- Wait for the tween to end
    task.wait(1)
end





----------------------------------------------------------------
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
-- üîó Connections üîó
-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

-- Binds events to functions

-- > Sorted by category and alphabetically
-- > Connections use camelCase
-- > Private connections have a underscore in front of them
----------------------------------------------------------------

-- ‚ñà üì° Connections üì° ‚ñà
gameLoadedRemote.Event:Connect(loadPlayer)
